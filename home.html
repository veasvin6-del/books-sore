<!doctype html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book Store</title>

  <!-- SheetJS (optional, for .xlsx import) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Store</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="logo.png">

    <link rel="stylesheet" href="style.css">
</head>

  <style>
  /* =========================
     GLOBAL / THEME VARIABLES
     ========================= */
  :root{
    --bg: #f4f6f9;
    --card: #ffffff;
    --muted: #6b7280;
    --primary-1: #1e3a8a;
    --primary-2: #4f46e5;
    --accent: #ec4899;
    --success: #10b981;
    --danger: #ef4444;
    --glass: rgba(255,255,255,0.75);
    --radius: 12px;
    --rate: 4000;
    --text: #111;
  }
  [data-theme="dark"]{
    --bg: #071127;
    --card: #0c1724;
    --muted: #98a0b3;
    --primary-1: #0b1220;
    --primary-2: #3b82f6;
    --accent: #ff66b3;
    --text: #edf2ff;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Battambang", system-ui, Arial, sans-serif;-webkit-font-smoothing:antialiased;background:var(--bg);color:var(--text)}
  img{display:block;max-width:100%}

  /* subtle background image layer */
  body::before{
    content:"";
    position:fixed; inset:0; z-index:-2;
    background-image: url('background.png');
    background-size:cover;
    background-position:center;
    opacity:0.06;
    pointer-events:none;
  }
  /* ===== TOPBAR (centered title + logo) ===== */
  .topbar{
    position:sticky; top:0; z-index:120;
    display:flex; align-items:center; justify-content:center;
    gap:14px; padding:20px; background:linear-gradient(90deg,var(--primary-1),var(--primary-2));
    color:white; box-shadow:0 8px 30px rgba(0,0,0,0.12);
  }
  .topbar .center {
    display:flex; align-items:center; gap:12px; justify-content:center;
  }
  .topbar .logo {
    width:56px; height:56px; flex-shrink:0; border-radius:10px; overflow:hidden;
    display:inline-flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.08);
  }
  .topbar h1{ margin:0; font-size:28px; font-weight:800; text-shadow:0 4px 10px rgba(0,0,0,0.18) }

  /* theme toggle positioned to right (absolute within topbar) */
  .theme-wrap{ position:absolute; right:14px; top:50%; transform:translateY(-50%); }
  .theme-btn{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
    background:rgba(255,255,255,0.12); border-radius:10px; color:white; border:none; cursor:pointer; font-weight:700;
  }
  [data-theme="dark"] .theme-btn{ background:rgba(255,255,255,0.08); color:var(--text); }

  /* ===== APP & CONTROLS ===== */
  .app{ padding:14px; max-width:1150px; margin:10px auto 80px; }

  .controls{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
  .file-btn{ background:var(--card); padding:10px 14px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); cursor:pointer; display:inline-flex; gap:8px; align-items:center; font-weight:700; color:var(--muted) }
  .file-btn input{ display:none }
  .btn{ padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700 }
  .btn.primary{ background:linear-gradient(90deg,var(--primary-1),var(--primary-2)); color:white; box-shadow:0 8px 24px rgba(37,99,235,0.12) }
  .btn.ghost{ background:transparent; border:1px solid rgba(0,0,0,0.06) }

  .search{ flex:1; display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; background:var(--card); border:1px solid rgba(0,0,0,0.06) }
  .search input{ display:block; width:100%; border:none; outline:none; background:transparent; font-size:15px; color:var(--text) }

  /* ===== CARD & TABLE ===== */
  .card{ background:var(--card); border-radius:14px; padding:12px; box-shadow:0 12px 30px rgba(11,18,37,0.06); border:1px solid rgba(0,0,0,0.03) }
  .table-wrap{ overflow:auto; -webkit-overflow-scrolling:touch; border-radius:10px; margin-top:10px; max-height:68vh }
  table{ width:100%; border-collapse:collapse; min-width:720px; font-size:15px; }
  thead th{ position:sticky; top:0; z-index:30; background:var(--accent); color:white; padding:12px 14px; text-align:left; font-weight:800; border-bottom:3px solid rgba(0,0,0,0.06) }
  tbody td{ padding:12px 14px; border-bottom:1px solid rgba(0,0,0,0.04); vertical-align:middle; color:var(--text) }
  tbody tr:hover{ background: rgba(0,0,0,0.02) }

  .col-name{ min-width:260px }
  .col-khr{ width:200px; text-align:center }
  .col-usd{ width:120px; text-align:center }
  .col-actions{ width:160px; text-align:right; padding-right:18px }

  .action-btn{ padding:8px 12px; border-radius:8px; border:none; font-weight:700; margin-left:8px; cursor:pointer }
  .edit-btn{ background:var(--success); color:white }
  .delete-btn{ background:var(--danger); color:white }

  .empty{ padding:18px; text-align:center; color:var(--muted) }

  /* ===== MODAL ===== */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,0.45); z-index:9999 }
  .modal.show{ display:flex }
  .modal-card{ width:94%; max-width:540px; background:var(--card); border-radius:12px; padding:18px; box-shadow:0 20px 60px rgba(2,6,23,0.18) }
  .modal-card h2{ margin:0 0 12px; color:var(--text) }
  .form-row{ display:flex; gap:10px; flex-wrap:wrap }
  .form-row .col{ flex:1; min-width:140px }
  label{ display:block; font-weight:700; margin-bottom:6px; color:var(--muted) }
  input[type="text"], input[type="number"]{ width:100%; padding:10px; border-radius:10px; border:1px solid #e6eaf2; font-size:15px; color:var(--text); background:transparent }
  .modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:16px }

  /* responsive */
  @media (max-width:820px){
    .topbar h1{ font-size:20px }
    table{ min-width:600px }
    .search input{ font-size:14px }
    .btn{ padding:8px 10px }
  }
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <div class="topbar" role="banner" id="topbar">
    <div class="center">
      <div class="logo"><img src="logo.png" alt="logo" style="width:100%;height:100%;object-fit:contain"></div>
      <h1>Book Store</h1>
    </div>

    <div class="theme-wrap">
      <button id="themeToggle" class="theme-btn" aria-label="Toggle theme">
        <span class="ico">üåô</span><span class="txt">Theme</span>
      </button>
    </div>
  </div>

  <!-- APP -->
  <div class="app">
    <div class="controls">
      <label class="file-btn" title="Load local CSV/XLSX">
        üìÅ Load CSV/XLSX
        <input id="localCsvInput" type="file" accept=".csv,.xlsx,.xls" />
      </label>

      <button id="exportBtn" class="btn ghost" title="Export CSV">Export CSV</button>

      <div class="search" aria-hidden="false">
        <span style="opacity:.7">üîé</span>
        <input id="searchInput" type="search" placeholder="·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ / Search..." />
      </div>

      <button id="addBtn" class="btn primary" title="Add Book">+ Add Book</button>
    </div>

    <div class="card">
      <div class="table-wrap" id="tableWrap">
        <table id="bookTable" role="table" aria-label="Books table">
          <thead>
            <tr>
              <th style="width:60px"></th>
              <th class="col-name">·ûà·üí·ûò·üÑ·üá·ûü·üÄ·ûú·ûó·üÖ</th>
              <th class="col-khr">·ûè·ûò·üí·ûõ·üÉ (KHR)</th>
              <th class="col-usd">·ûè·ûò·üí·ûõ·üÉ ($)</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div id="empty" class="empty" style="display:none">No data. Load <strong>books.csv</strong> or add a book.</div>
    </div>
  </div>

  <!-- MODAL (Add / Edit) -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <h2 id="modalTitle">Add Book</h2>
      <input id="editIndex" type="hidden" value="" />

      <div style="margin-top:6px">
        <label>·ûà·üí·ûò·üÑ·üá·ûü·üÄ·ûú·ûó·üÖ</label>
        <input id="bookName" type="text" placeholder="Book title" />
      </div>

      <div class="form-row" style="margin-top:10px">
        <div class="col">
          <label>·ûè·ûò·üí·ûõ·üÉ (KHR)</label>
          <input id="priceKHR" type="number" inputmode="numeric" placeholder="e.g. 28000" />
        </div>
        <div class="col">
          <label>·ûè·ûò·üí·ûõ·üÉ (USD)</label>
          <input id="priceUSD" type="text" placeholder="$ auto" readonly />
        </div>
      </div>

      <div class="modal-actions">
        <button id="cancelBtn" class="btn ghost">Cancel</button>
        <button id="saveBtn" class="btn primary">Save</button>
      </div>
    </div>
  </div>

  <script>
  /* ============================
     Full JS: Storage, Import, Search, Theme, Modal
     ============================ */

  const STORAGE_KEY = 'bookstore_data_v1';
  const THEME_KEY = 'bookstore_theme';
  const RATE = 4000;

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // state
  let books = [];
  let searchIndex = [];

  // ---------- storage ----------
  function loadFromStorage(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      books = raw ? JSON.parse(raw) : [];
    } catch(e){
      books = [];
    }
  }
  function saveToStorage(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(books)); }

  // ---------- render ----------
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function render(list = books){
    const tbody = $('#tableBody');
    if(!tbody) return;
    const data = Array.isArray(list) ? list : books;
    if(!data || data.length === 0){ tbody.innerHTML = ''; $('#empty').style.display = 'block'; return; }
    $('#empty').style.display = 'none';

    let html = '';
    for(let i=0;i<data.length;i++){
      const b = data[i];
      const khrText = (b.khr !== '' && b.khr !== undefined) ? String(Number(b.khr)).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '';
      const usdText = (b.usd !== '' && b.usd !== undefined) ? Number(b.usd).toFixed(2) : '';
      html += `<tr data-idx="${i}">
        <td style="padding-left:12px"></td>
        <td class="col-name">${escapeHtml(b.name||'')}</td>
        <td class="col-khr">KHR ${khrText}</td>
        <td class="col-usd">${usdText ? ('$ ' + usdText) : ''}</td>
        <td class="col-actions">
          <button class="action-btn edit-btn" data-i="${i}">Edit</button>
          <button class="action-btn delete-btn" data-i="${i}">Delete</button>
        </td>
      </tr>`;
    }
    tbody.innerHTML = html;

    // attach handlers (delegation could be used; attaching after render is fine)
    $$('.edit-btn').forEach(btn => btn.onclick = e => openEdit(Number(e.currentTarget.dataset.i)));
    $$('.delete-btn').forEach(btn => btn.onclick = e => deleteBook(Number(e.currentTarget.dataset.i)));
  }

  // ---------- parse CSV robust ----------
  function parseCSVText(text){
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    const rows = [];
    for(const line of lines){
      const cols = []; let cur = '', inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){
          if(inQ && line[i+1] === '"'){ cur += '"'; i++; continue; }
          inQ = !inQ; continue;
        }
        if(ch === ',' && !inQ){ cols.push(cur); cur = ''; continue; }
        cur += ch;
      }
      cols.push(cur);
      rows.push(cols);
    }
    return rows;
  }

  // ---------- import file (CSV/XLSX) ----------
  $('#localCsvInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const name = (file.name || '').toLowerCase();
    try {
      if(name.endsWith('.csv')){
        const txt = await file.text();
        const rows = parseCSVText(txt);
        applyRows(rows);
      } else {
        const ab = await file.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });
        const arr = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header:1, raw:false });
        applyRows(arr);
      }
      saveToStorage(); rebuildIndex(); render();
      alert('File loaded');
    } catch(err){
      console.error(err);
      alert('Failed to load file: ' + (err.message||err));
    } finally {
      try { $('#localCsvInput').value = ''; } catch(e){}
    }
  });

  // apply rows -> map header names
  function applyRows(rows){
    if(!rows || rows.length === 0) return;
    const header = rows[0].map(h => String(h||'').trim().toLowerCase());
    const dataRows = rows.slice(1);
    const mapped = dataRows.map(r => {
      const obj = {};
      header.forEach((h, idx) => obj[h] = r[idx] ? String(r[idx]).trim() : '');
      return {
        name: obj['book title'] || obj['title'] || obj['name'] || '',
        khr: Number(cleanCurrency(obj['price/unit'] || obj['khr'] || obj['price khr'] || '')) || '',
        usd: formatUSD(obj['usd'] || obj['price usd'] || (obj['price/unit'] ? cleanCurrency(obj['price/unit'])/RATE : ''))
      };
    }).filter(x => x.name);
    books = mapped;
  }

  // ---------- helpers ----------
  function cleanCurrency(v){ if(v===undefined||v===null) return ''; return String(v).replace(/[^0-9.-]/g,'').trim(); }
  function formatUSD(v){ if(v===undefined||v===null||v==='') return ''; const n = Number(String(v).replace(/[^0-9.-]/g,'')); return isNaN(n) ? '' : Number(n).toFixed(2); }

  // ---------- add / edit / delete ----------
  $('#addBtn').addEventListener('click', ()=> openModal('add'));
  $('#cancelBtn').addEventListener('click', closeModal);
  $('#saveBtn').addEventListener('click', saveFromModal);

  function openModal(mode='add'){
    const modal = $('#modal');
    modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
    $('#modalTitle').innerText = mode === 'add' ? 'Add Book' : 'Edit Book';
    if(mode === 'add'){ $('#editIndex').value = ''; $('#bookName').value = ''; $('#priceKHR').value = ''; $('#priceUSD').value = ''; }
    setTimeout(()=> { try{ $('#bookName').focus(); } catch(e){} }, 160);
  }
  function closeModal(){ const modal = $('#modal'); modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

  function openEdit(i){
    const b = books[i]; if(!b) return;
    $('#editIndex').value = i; $('#bookName').value = b.name || ''; $('#priceKHR').value = b.khr || ''; $('#priceUSD').value = b.usd || '';
    openModal('edit');
  }

  $('#priceKHR').addEventListener('input', ()=> {
    const v = cleanCurrency($('#priceKHR').value);
    if(!v){ $('#priceUSD').value = ''; return; }
    $('#priceUSD').value = (Number(v)/RATE).toFixed(2);
  });

  async function saveFromModal(){
    const idx = $('#editIndex').value;
    const name = ($('#bookName').value||'').trim();
    const khr = cleanCurrency($('#priceKHR').value);
    const usd = formatUSD($('#priceUSD').value || (khr ? (Number(khr)/RATE) : ''));

    if(!name){ alert('·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûà·üí·ûò·üÑ·üá·ûü·üÄ·ûú·ûó·üÖ'); return; }

    const entry = { name, khr: khr ? Number(khr) : '', usd };

    if(idx === '') books.unshift(entry); else books[Number(idx)] = entry;
    saveToStorage(); rebuildIndex(); render(); closeModal();
  }

  function deleteBook(i){
    if(!confirm('Delete this book?')) return;
    books.splice(i,1); saveToStorage(); rebuildIndex(); render();
  }

  // ---------- export ----------
  $('#exportBtn').addEventListener('click', ()=>{
    if(!books.length) return alert('No data to export');
    const header = ['Book Title','Price/Unit','USD'];
    const rows = books.map(b => [b.name||'', b.khr||'', b.usd||'']);
    const csv = [header, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'books_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // ---------- search (fast pre-indexed + debounce) ----------
  function rebuildIndex(){ searchIndex = books.map(b => ((b.name||'') + ' ' + (b.khr||'') + ' ' + (b.usd||'')).toLowerCase()); }
  function debounce(fn, t=110){ let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn(...a), t); }; }

  const doSearch = debounce(()=> {
    const q = ($('#searchInput').value||'').trim().toLowerCase();
    if(!q){ render(); return; }
    const filtered = [];
    for(let i=0;i<searchIndex.length;i++){ if(searchIndex[i].includes(q)) filtered.push(books[i]); }
    render(filtered);
  }, 80);
  $('#searchInput').addEventListener('input', doSearch);

  // ---------- theme toggle Option A (auto icon switch) ----------
  const themeBtn = $('#themeToggle');
  function setTheme(mode){
    if(mode === 'dark'){ document.documentElement.setAttribute('data-theme','dark'); themeBtn.querySelector('.ico').textContent = '‚òÄÔ∏è'; }
    else { document.documentElement.removeAttribute('data-theme'); themeBtn.querySelector('.ico').textContent = 'üåô'; }
    localStorage.setItem(THEME_KEY, mode);
  }
  themeBtn.addEventListener('click', ()=> {
    const cur = localStorage.getItem(THEME_KEY) || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    setTheme(cur === 'dark' ? 'light' : 'dark');
  });

  function initTheme(){
    const s = localStorage.getItem(THEME_KEY) || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    setTheme(s);
  }

  // ---------- auto-load books.csv if available (only works on http(s)) ----------
  async function tryAutoLoadCSV(){
    try{
      const res = await fetch('books.csv');
      if(!res.ok) return;
      const txt = await res.text();
      const rows = parseCSVText(txt);
      if(rows.length <= 1) return;
      applyRows(rows);
      if(!localStorage.getItem(STORAGE_KEY) || JSON.parse(localStorage.getItem(STORAGE_KEY)).length === 0){
        saveToStorage();
      }
    } catch(e){
      // ignore errors (file:// will fail)
    }
  }

  // ---------- init ----------
  (async function init(){
    initTheme();
    loadFromStorage();
    await tryAutoLoadCSV();
    rebuildIndex();
    render();
  })();
function render(list = books){
    const tbody = $('#tableBody');
    if(!tbody) return;
    const data = Array.isArray(list) ? list : books;

    // mapping index (new!)
    const indexMap = data.map(d => books.indexOf(d));

    let html = '';
    for(let i=0;i<data.length;i++){
      const b = data[i];
      const khrText = (b.khr !== '' && b.khr !== undefined) ? String(Number(b.khr)).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '';
      const usdText = (b.usd !== '' && b.usd !== undefined) ? Number(b.usd).toFixed(2) : '';
      html += `<tr data-idx="${indexMap[i]}">
        <td style="padding-left:12px"></td>
        <td class="col-name">${escapeHtml(b.name||'')}</td>
        <td class="col-khr">KHR ${khrText}</td>
        <td class="col-usd">${usdText ? ('$ ' + usdText) : ''}</td>
        <td class="col-actions">
          <button class="action-btn edit-btn" data-i="${indexMap[i]}">Edit</button>
          <button class="action-btn delete-btn" data-i="${indexMap[i]}">Delete</button>
        </td>
      </tr>`;
    }
    tbody.innerHTML = html;

    $$('.edit-btn').forEach(btn => btn.onclick = e => openEdit(Number(e.currentTarget.dataset.i)));
    $$('.delete-btn').forEach(btn => btn.onclick = e => deleteBook(Number(e.currentTarget.dataset.i)));
}

  </script>
</body>
</html>

